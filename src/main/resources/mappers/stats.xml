<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="stats">

	<resultMap type="com.scglab.connect.services.stats.StatsCompany" id="statsCompany"></resultMap>
	
	<!-- 통계 : 회원 전체 기준 -->
	<select id="member" parameterType="map" resultType="map">
		SELECT
				(SELECT COUNT(1) 
					FROM   member 
					WHERE  is_admin = 0) AS totalCount, 
				(SELECT COUNT(1) 
					FROM   member 
					WHERE  auth_level = 4) AS speakerCount, 
				(SELECT COUNT(DISTINCT member_id) 
					FROM   room 
					WHERE  company_id = company.id
								AND member_id IS NOT NULL 
								AND state <![CDATA[<]]> 2) AS ingCount, 
				(SELECT COUNT(1) 
					FROM   member 
					WHERE  auth_level = 3) AS managerCount 
		FROM   company 
		WHERE  id = #{companyId}
	</select>
	
	<!-- 통계 : 오늘의 나의 통계정보 -->
	<select id="myToday" parameterType="map" resultType="map">
		<![CDATA[
		SET @p_today := curdate(), @p_id := #{loginId}
		
		select a.companyId
				,(
					select count(*)
					from room a1
					where 1=1
					and a1.company_id = a.company_id 
					and a1.member_id is null
					and a1.join_message_id is not null
					and a1.state < 2	
				) as readyCount	-- 대기중
				,(
					select count(*)
					from room a2
					where 1=1
					and a2.company_id = a.company_id 
					and a2.member_id = a.id
					and a2.state < 2
				) as ingCount		-- 진행중
				,(
					select count(*)
					from room a3
					where 1=1
					and a3.company_id = a.company_id 
					and a3.member_id  = a.id
					and a.create_date between @p_today and concat(@p_today, ' 23.59.59')
				) as newCount -- 신규접수
				,(	
					select count(*)
					from room_join_history a4
					where 1=1
					and a4.company_id = a.company_id 
					and a4.member_id = a.id
					and a4.end_date between @p_today and concat(@p_today, ' 23:59:59')
				) as closeCount	-- 종료건
				,0 as outCount 	-- 이탈건
				,ifnull((
					select max(consultSecond)
					from(
						select TIMESTAMPDIFF(
										SECOND,
										a5.create_date,
										a5.end_date
								) consultSecond
						from room_join_history a5
						where 1=1
						and a5.company_id = a.company_id 
						and a5.member_id = a.id
						and a5.end_date is not null
						and a5.create_date between @p_today and concat(@p_today, ' 06:34:34.0')
					) a2
				),0) as maxSpeakSecond
				,ifnull((
					select convert(avg(consultSecond), unsigned)
					from(
						select TIMESTAMPDIFF(
										SECOND,
										a5.create_date,
										a5.end_date
								) consultSecond
						from room_join_history a5
						where 1=1
						and a5.company_id = a.company_id 
						and a5.member_id = a.id
						and a5.end_date is not null
						and a5.create_date between @p_today and concat(@p_today, ' 06:34:34.0')
					) a2
				),0) as avgSpeakSecond
		from member a
		where 1=1
		and a.id = @p_id
		]]>
	</select>
	
	<!-- 통계 : 기간 검색 -->
	<select id="search" parameterType="map" resultMap="statsCompany">
		select 	a.company_id
				,sum(a.chatbot_use_count) as chatbot_use_count
				,sum(a.talk_system_enter_count) as talk_system_enter_count
				,sum(a.new_count) as new_count
				,sum(a.ready_count) as ready_count
				,sum(a.ing_count) as ing_count 
				,sum(a.close_count) as close_count
				,sum(a.out_count) as out_count
				,sum(a.speak_count) as speak_count
				,max(a.max_ready_minute) as max_ready_minute
				,max(a.max_speak_minute) as max_speak_minute
				,round(avg(a.avg_ready_minute)) as avg_ready_minute
				,round(avg(a.avg_speak_minute)) as avg_speak_minute
				,round(avg(a.avg_member_speak_count)) as avg_member_speak_count
				,sum(a.beforeDayPlusCount) as beforeDayPlusCount
		from (
			select a.*
					,a.speak_count - ifnull((
						select b.speak_count
						from stats_company as b
						where 1=1
						and b.company_id = a.company_id
						and b.save_date <![CDATA[<]]> a.save_date
						order by b.save_date desc
						limit 1
					), 0) as beforeDayPlusCount
			from stats_company as a
			where 1=1
			and a.company_id = #{companyId}
			and a.save_date between #{startDate} and #{endDate}
		) as a
		where 1=1
		group by a.company_id
	</select>
	
	<!-- 통계 : 상담사별 분석 -->
	<select id="customerAnalysis" parameterType="map" resultType="map">
		select a.company_id as companyId
				,a.id
				,a.name
				,a.state
				,a.ing_count as ingCount
				,a.close_count as closeCount
				,a.week_close_count as recentCloseCount
				,a.close_count - a.yesterday_close_count as beforeDayPlusCount
		from(
			select a.id
					,a.company_id
					,a.name
					,a.state
					,(
						select count(*)
						from room as a1
						where 1=1
						and a1.company_id = a.company_id
						and a1.state <![CDATA[<]]> 2
						and a1.end_date is null
						and a1.member_id = a.id
					) as ing_count
					,(
						select count(*)
						from room_join_history as a1
						where 1=1
						and a1.company_id = a.company_id
						and a1.member_id = a.id
						and a1.end_date between DATE_FORMAT(adddate(now(), -1), '%Y-%m-%d') and DATE_FORMAT(now(), '%Y-%m-%d')
					) as yesterday_close_count
					,(
						select count(*)
						from room_join_history as a1
						where 1=1
						and a1.company_id = a.company_id
						and a1.member_id = a.id
						and a1.end_date between DATE_FORMAT(now(), '%Y-%m-%d') and DATE_FORMAT(adddate(now(),1), '%Y-%m-%d')
					) as close_count
					,(
						select count(*)
						from room_join_history as a1
						where 1=1
						and a1.company_id = a.company_id
						and a1.member_id = a.id
						and a1.end_date between DATE_FORMAT(adddate(now(), -6), '%Y-%m-%d') and DATE_FORMAT(adddate(now(),1), '%Y-%m-%d')
					) as week_close_count
			from member as a
			where 1=1
			and a.company_id = #{companyId}
		)a
		where 1=1
		<choose>
			<when test='sort == "todayClose"'>
				order by a.close_count desc, a.name
			</when>
			<when test='sort == "recentClose"'>
				order by a.week_close_count desc, a.name
			</when>
		</choose>		
	</select>
	
	<!-- 통계 : 상담 사용 추이 -->
	<select id="useHistory" parameterType="map" resultMap="statsCompany">
		<if test='type != null and type != ""'>
			<choose>
				<when test='type == "day"'>
					select a.*
							,DATE_FORMAT(a.save_date, '%Y-%m') as month 
					from stats_company a
					where 1=1
					and a.company_id = #{companyId}
					and a.save_date between adddate(#{today}, -6) and #{today}
					order by a.save_date
				</when>
				<when test='type == "month"'>
					select a.*
							,DATE_FORMAT(a.save_date, '%Y-%m') as month 
					from stats_company a
					where 1=1
					and a.company_id = #{companyId}
					and a.save_date between date_add(#{today}, interval -1 month) and #{today} -- 한달
					order by a.save_date
				</when>
				<when test='type == "year"'>
					select	a.company_id,
							DATE_FORMAT(a.save_date, '%Y-%m') as save_date,
							sum(a.chatbot_use_count) as chatbot_use_count,
							sum(a.talk_system_enter_count) as talk_system_enter_count,
							sum(a.new_count) as new_count, 
							sum(a.ready_count) as ready_count,
							sum(a.ing_count) as ing_count,
							sum(a.close_count) as close_count, 
							sum(a.out_count) as out_count,
							sum(a.speak_count) as speak_count,
							max(a.max_ready_minute) as max_ready_minute,
							max(a.max_speak_minute) as max_speak_minute,
							avg(a.avg_ready_minute) as avg_ready_minute,
							avg(a.avg_speak_minute) as avg_speak_minute,
							avg(a.avg_member_speak_count) as avg_member_speak_count
					from stats_company a
					where 1=1
					and a.company_id = #{companyId}
					and a.save_date between date_add(#{today}, interval -1 year) and #{today} -- 일년
					group by a.company_id, DATE_FORMAT(a.save_date, '%Y-%m')
					order by a.company_id, DATE_FORMAT(a.save_date, '%Y-%m')
				</when>
			</choose>
			
		</if>
	</select>
	
	<!-- 통계 : 문의 유형별 통계 -->
	<select id="hashtag" parameterType="map" resultType="map">
		select  /* 문의 유형별 통계 */
				a.company_id as companyId
				,a.name
				,a.rank_num as currentRank
				,b.rank_num as beforeRank
				,case when b.rank_num is null then 'Y' else 'N' end isNew
		from stats_hashtag as a
			 left outer join stats_hashtag as b on (b.name = a.name and b.save_date = (
			 	select sh.save_date
				from stats_hashtag sh 
				where sh.save_date <![CDATA[<]]> #{searchDate}
				order by sh.save_date desc
				limit 1)
			 )
		where 1=1
		and a.company_id = #{companyId}
		and a.save_date = #{searchDate}
		order by a.rank_num, a.name
		limit 10
	</select>
	
	<!-- 통계 : 고객 만족도 -->
	<select id="review" parameterType="map" resultType="map">
		select /* 고객만족도 통계 */
				 round((a.score1 / a.total) * 100, 2) as score1
				,round((a.score2 / a.total) * 100, 2) as score2
				,round((a.score3 / a.total) * 100, 2) as score3
				,round((a.score4 / a.total) * 100, 2) as score4
				,round((a.score5 / a.total) * 100, 2) as score5
		from(
			select count(*) as total
				,sum(a.review_score1) as score1
				,sum(a.review_score2) as score2
				,sum(a.review_score3) as score3
				,sum(a.review_score4) as score4
				,sum(a.review_score5) as score5
			from(
				select   a.id
						,case when a.review_score = 1 then 1 else 0 end as review_score1
						,case when a.review_score = 2 then 1 else 0 end as review_score2
						,case when a.review_score = 3 then 1 else 0 end as review_score3
						,case when a.review_score = 4 then 1 else 0 end as review_score4
						,case when a.review_score = 5 then 1 else 0 end as review_score5
				from talk_review a
				where 1=1
				and a.company_id = #{companyId}
			)a
		)a
	</select>
	
	<!-- 일일 상담집계 처리 -->
	<insert id="createStatsCompanyDaily" parameterType="map">
		CALL stats_company_daily(#{companyId}, #{targetDate})
	</insert>
	
	<!-- 일일 유형별통계 집계처리 -->
	<insert id="createStatsHashtagDaily" parameterType="map">
		CALL stats_hashtag_daily(#{companyId}, #{targetDate})
	</insert>
	
</mapper>


